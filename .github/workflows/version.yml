name: Deploy to Cloudflare Pages (Direct Upload)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "CrowdSec version/tag to deploy (e.g. v1.6.0). Leave empty to deploy latest release."
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'release' && github.event.release.prerelease == false)
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: 20

      - name: Pick CrowdSec version
        id: pick_version
        env:
          INPUT_VERSION: ${{ inputs.version }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [ -n "${INPUT_VERSION:-}" ]; then
            TAG="${INPUT_VERSION}"
          else
            # latest non-prerelease tag
            TAG="$(gh release list --json tagName --exclude-pre-releases --limit 1 | jq -r '.[0].tagName')"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Write dist artifact
        run: |
          set -euo pipefail
          mkdir -p ./dist
          echo '{"name":"${{ steps.pick_version.outputs.tag }}"}' > ./dist/latest
          cat ./dist/latest

      # Deploy the build output directory (adjust ./dist to your framework output)
      - name: Publish to Cloudflare Pages
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./dist --project-name version --branch main
