---
- name: "set package_file from package_dir"
  ansible.builtin.set_fact:
    package_file: "{{ package_dir }}/{{ releasever }}/RPMS/{{ ansible_facts.architecture }}/crowdsec-*.{{ releasever }}.{{ ansible_facts.architecture }}.rpm"
  when:
    - (package_dir is defined) and (package_dir | length > 0)

- name: "look for .rpm file matching package_file"
  ansible.builtin.set_fact:
    found_files: "{{ item }}"
  with_fileglob:
    - "{{ package_file }}"
  when:
    - (package_file is defined) and (package_file | length > 0)

- name: "check found_files"
  ansible.builtin.fail:
    msg: "No .rpm files found in {{ package_file }}"
  when:
    - found_files is not defined
    - (package_file is defined) and (package_file | length > 0)

- name: "check found_files"
  ansible.builtin.fail:
    msg: "{{ found_files | length }} files found in {{ package_file }}"
  when:
    - (found_files | length > 1)
    - (package_file is defined) and (package_file | length > 0)

- name: "copy built file for rpm-like"
  become: false
  ansible.builtin.copy:
    src: "{{ found_files[0] }}"
    dest: "{{ ansible_env.HOME }}/crowdsec.rpm"
    mode: 0o644
  when:
    - (package_file is defined) and (package_file | length > 0)

- name: "install crowdsec on rpm-like"
  become: true
  ansible.builtin.yum:
    name: "{{ ansible_env.HOME }}/crowdsec.rpm"
    disable_gpg_check: true
    allow_downgrade: true
  when:
    - (package_file is defined) and (package_file | length > 0)
